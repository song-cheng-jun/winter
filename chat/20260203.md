# 解决 ThinkPHP 后端跨域问题

## 用户的提问

### 问题1：我在本地运行web项目，访问接口报错跨域了，请解决这个问题

**错误信息：**
```
Access to XMLHttpRequest at 'http://lib.com/api/auth/login' from origin 'http://localhost:5173' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

### 问题2：还是会报错跨域
```
Access to XMLHttpRequest at 'http://lib.com/api/auth/login' from origin 'http://localhost:5173' has been blocked by CORS policy: Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

### 问题3：我看怎么配置文件路径
### 问题4：我直接访问 lib.com 都会报错
```
Warning: require(D:\codeHistory\winter\server\public/../vendor/autoload.php): Failed to open stream: No such file or directory
```

### 问题5：有报错，这是响应：
```
error: "SQLSTATE[42S02]: Base table or view not found: 1146 Table 'library.users' doesn't exist"
```

### 问题6：你可以自己执行吗

---

## 解决过程

### 1. 项目分析

首先探索了 `server` 目录，发现这是一个 **ThinkPHP 8.x** 项目：
- 框架：ThinkPHP 8.0
- PHP 要求：>= 8.0.0
- 入口文件：`public/index.php`
- 全局中间件配置：`app/middleware.php`
- **项目没有任何 CORS 配置**

### 2. 创建 CORS 中间件

创建了 `[app/middleware/Cors.php](app/middleware/Cors.php)`：

```php
<?php
declare (strict_types = 1);

namespace app\middleware;

use think\Request;
use think\Response;

class Cors
{
    public function handle(Request $request, \Closure $next)
    {
        $origin = $request->header('origin') ?? '*';

        // 处理OPTIONS预检请求
        if ($request->method() == 'OPTIONS') {
            return Response::create('', 'html', 204)->header([
                'Access-Control-Allow-Origin' => $origin,
                'Access-Control-Allow-Methods' => 'GET, POST, PUT, DELETE, OPTIONS, PATCH',
                'Access-Control-Allow-Headers' => 'Authorization, Content-Type, X-Requested-With, Accept, Origin',
                'Access-Control-Allow-Credentials' => 'true',
                'Access-Control-Max-Age' => '86400',
            ]);
        }

        $response = $next($request);
        $response->header([
            'Access-Control-Allow-Origin' => $origin,
            'Access-Control-Allow-Methods' => 'GET, POST, PUT, DELETE, OPTIONS, PATCH',
            'Access-Control-Allow-Headers' => 'Authorization, Content-Type, X-Requested-With, Accept, Origin',
            'Access-Control-Allow-Credentials' => 'true',
            'Access-Control-Max-Age' => '86400',
        ]);

        return $response;
    }
}
```

### 3. 注册全局中间件

修改 `[app/middleware.php](app/middleware.php)`：

```php
<?php
return [
    // CORS跨域中间件
    \app\middleware\Cors::class,
    // 其他中间件...
];
```

### 4. 在入口文件添加 CORS 处理（确保优先执行）

修改 `[public/index.php](public/index.php)`：

```php
use think\App;

require __DIR__ . '/../vendor/autoload.php';

// CORS 跨域处理 - 在应用执行之前设置响应头
if (isset($_SERVER['HTTP_ORIGIN'])) {
    $origin = $_SERVER['HTTP_ORIGIN'];
    header("Access-Control-Allow-Origin: $origin");
    header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH');
    header('Access-Control-Allow-Headers: Authorization, Content-Type, X-Requested-With, Accept, Origin');
    header('Access-Control-Allow-Credentials: true');
    header('Access-Control-Max-Age: 86400');

    // 处理 OPTIONS 预检请求
    if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
        http_response_code(204);
        exit;
    }
}

$http = (new App())->http;
$response = $http->run();
$response->send();
$http->end($response);
```

### 5. 安装 Composer 依赖

```bash
cd d:/codeHistory/winter/server
composer install
```

安装成功，包含以下依赖：
- firebase/php-jwt (JWT 认证)
- topthink/framework (ThinkPHP 框架)
- topthink/think-orm (ORM)

### 6. 修复 BaseController 引入问题

**错误：** `Class "app\controller\BaseController" not found`

**原因：** AuthController 继承的 BaseController 命名空间是 `app\BaseController`

**解决方案：** 在 `[app/controller/AuthController.php](app/controller/AuthController.php)` 添加 use 语句：

```php
namespace app\controller;

use app\BaseController;  // 添加这行
use app\model\User;
use Firebase\JWT\JWT;
use think\facade\Request;
```

### 7. 创建数据库表和测试用户

创建 `[create_table.php](create_table.php)` 脚本并执行：

```bash
php create_table.php
```

**执行结果：**
```
用户表创建成功！
测试用户创建成功！
用户名: admin
密码: admin123
```

---

## 最终解决方案总结

### 修改的文件：

1. **[app/middleware/Cors.php](app/middleware/Cors.php)** - 新建 CORS 中间件
2. **[app/middleware.php](app/middleware.php)** - 注册 CORS 中间件
3. **[public/index.php](public/index.php)** - 添加 CORS 响应头
4. **[app/controller/AuthController.php](app/controller/AuthController.php)** - 修复 BaseController 引入
5. **[create_table.php](create_table.php)** - 数据库表创建脚本

### 测试账号：

- **用户名**: admin
- **密码**: admin123

### CORS 配置说明：

- 允许的来源：动态获取请求来源
- 允许的方法：GET, POST, PUT, DELETE, OPTIONS, PATCH
- 允许的请求头：Authorization, Content-Type, X-Requested-With, Accept, Origin
- 允许携带凭证：true
- 预检请求缓存：86400 秒

---

## 遇到的问题及解决

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 跨域错误 | 后端没有配置 CORS | 创建中间件 + 入口文件添加响应头 |
| composer 依赖缺失 | 没有运行 composer install | 运行 composer install |
| BaseController 找不到 | 命名空间错误 | 添加 use app\BaseController |
| 数据库表不存在 | users 表未创建 | 创建表并插入测试数据 |

---

## 日期

2026-02-03

---

# 安装 Element Plus 并添加密码显示/隐藏功能

## 用户的提问

### 问题1：安装element-plus ;然后登录页面的密码框加眼睛图标，可以点击切换密码的显示

### 问题2：你还没有在main.ts 中引入element plus

---

## 解决过程

### 1. 安装 element-plus

执行命令安装依赖：

```bash
npm install element-plus @element-plus/icons-vue --prefix web
```

安装成功，包含以下依赖：
- element-plus: ^2.13.2
- @element-plus/icons-vue: ^2.3.2

### 2. 在 main.ts 中全局引入 element-plus

修改 [web/src/main.ts](web/src/main.ts)：

```typescript
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'

import App from './App.vue'
import router from './router'

const app = createApp(App)

app.use(createPinia())
app.use(router)
app.use(ElementPlus)

// 注册所有图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}

app.mount('#app')
```

### 3. 修改登录页面添加密码显示/隐藏功能

修改 [web/src/views/Login.vue](web/src/views/Login.vue)：

**Template 部分：**
```vue
<div class="form-item">
  <label for="password">密码</label>
  <div class="password-input-wrapper">
    <input
      id="password"
      v-model="loginForm.password"
      :type="showPassword ? 'text' : 'password'"
      placeholder="请输入密码"
      :disabled="loading"
      @blur="validateField('password')"
    />
    <div class="eye-icon" @click="togglePasswordVisibility">
      <el-icon v-if="showPassword"><View/></el-icon>
      <el-icon v-else><Hide /></el-icon>
    </div>
  </div>
  <span v-if="errors.password" class="error-text">{{ errors.password }}</span>
</div>
```

**Script 部分：**
```typescript
// 密码可见性
const showPassword = ref(false)

/**
 * 切换密码可见性
 */
const togglePasswordVisibility = () => {
  showPassword.value = !showPassword.value
}
```

**Style 部分：**
```scss
.password-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;

  input {
    padding-right: 40px;
  }

  .eye-icon {
    position: absolute;
    right: 12px;
    cursor: pointer;
    color: #909399;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    transition: color 0.2s;

    &:hover {
      color: #409eff;
    }
  }
}
```

---

## 最终解决方案总结

### 修改的文件：

1. **[web/package.json](web/package.json)** - 添加 element-plus 依赖
2. **[web/src/main.ts](web/src/main.ts)** - 全局引入 element-plus 和注册图标组件
3. **[web/src/views/Login.vue](web/src/views/Login.vue)** - 添加密码显示/隐藏功能

### 功能说明：

- 点击密码框右侧的眼睛图标可以切换密码的显示/隐藏
- 使用 Element Plus 的 `<View />` 和 `<Hide />` 图标组件
- 图标悬停时会高亮显示（蓝色）

---

## 日期

2026-02-03
