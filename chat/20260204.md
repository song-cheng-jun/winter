# 权限功能模块开发

## 用户的提问

**需求：** 补充系统上的权限功能模块，先做后台接口，并且输出接口文档。

需要包含：
1. **用户模块**：能增删改查用户
2. **角色模块**：角色可以添加到用户上，角色上关联着权限（有哪些前端页面）
3. **前端路由菜单**：树形无限级添加，用来动态渲染前端路由表，区分是目录还是可跳转的路由

---

## 解决过程

### 1. 数据库表设计

创建了完整的 RBAC 权限系统数据库表，包括：

| 表名 | 说明 |
|------|------|
| `roles` | 角色表 |
| `user_roles` | 用户-角色关联表（多对多） |
| `menus` | 菜单表（支持无限级树形结构） |
| `permissions` | 权限表 |
| `role_permissions` | 角色-权限关联表 |
| `role_menus` | 角色-菜单关联表 |

**SQL 脚本位置**: [server/create_rbac_tables.sql](server/create_rbac_tables.sql)

**初始化数据**：
- 3个默认角色（超级管理员、管理员、普通用户）
- 6个系统菜单
- 28个系统权限
- 超级管理员自动分配所有权限和菜单

### 2. 创建模型文件

创建了 6 个新模型：

| 文件 | 说明 |
|------|------|
| [app/model/Role.php](server/app/model/Role.php) | 角色模型，关联用户、权限、菜单 |
| [app/model/Permission.php](server/app/model/Permission.php) | 权限模型，关联菜单 |
| [app/model/Menu.php](server/app/model/Menu.php) | 菜单模型，支持树形结构 |
| [app/model/UserRole.php](server/app/model/UserRole.php) | 用户角色关联模型 |
| [app/model/RolePermission.php](server/app/model/RolePermission.php) | 角色权限关联模型 |
| [app/model/RoleMenu.php](server/app/model/RoleMenu.php) | 角色菜单关联模型 |

**修改 User 模型**，添加与角色的多对多关系：
- 添加 `roles()` 关联方法
- 添加 `getRoleIds()` 获取用户角色
- 添加 `hasRole()` 检查用户是否有指定角色
- 添加 `getPermissionCodes()` 获取用户权限代码
- 添加 `getMenuIds()` 获取用户菜单ID

### 3. 创建权限验证中间件

**文件**: [app/middleware/Permission.php](server/app/middleware/Permission.php)

功能：
- 路由与权限代码映射
- 超级管理员跳过验证
- 通过用户角色检查权限
- 返回 403 错误当无权限访问

### 4. 创建控制器

创建了 4 个新的管理控制器：

| 文件 | 接口数量 | 说明 |
|------|----------|------|
| [app/controller/UserController.php](server/app/controller/UserController.php) | 9个 | 用户CRUD、角色分配、状态管理、密码重置 |
| [app/controller/RoleController.php](server/app/controller/RoleController.php) | 10个 | 角色CRUD、权限分配、菜单分配 |
| [app/controller/MenuController.php](server/app/controller/MenuController.php) | 6个 | 菜单CRUD、树形结构查询 |
| [app/controller/PermissionController.php](server/app/controller/PermissionController.php) | 6个 | 权限CRUD、分组查询 |

**修改 AuthController**，添加新方法：
- `getUserMenus()` - 获取当前用户菜单树
- `getUserPermissions()` - 获取当前用户权限列表
- `getUserCompleteInfo()` - 获取当前用户完整信息（包含角色、菜单、权限）

### 5. 配置路由

**文件**: [server/route/app.php](server/route/app.php)

新增路由组：
- `/api/users/*` - 用户管理路由（9个接口）
- `/api/roles/*` - 角色管理路由（10个接口）
- `/api/menus/*` - 菜单管理路由（6个接口）
- `/api/permissions/*` - 权限管理路由（6个接口）
- `/api/auth/menus` - 获取当前用户菜单
- `/api/auth/permissions` - 获取当前用户权限
- `/api/auth/info` - 获取当前用户完整信息

### 6. 注册中间件

**文件**: [server/config/middleware.php](server/config/middleware.php)

注册权限中间件别名：
```php
'permission' => app\middleware\Permission::class,
```

### 7. 输出接口文档

**文件**: [server/API_DOCUMENTATION.md](server/API_DOCUMENTATION.md)

包含所有接口的详细文档：
- 请求方式和路径
- 请求参数说明
- 响应示例
- 权限要求
- 错误码说明

---

## 最终解决方案总结

### 创建的文件（共13个）

**数据库脚本**:
- [server/create_rbac_tables.sql](server/create_rbac_tables.sql)
- [server/execute_sql.php](server/execute_sql.php)

**模型文件**:
- [server/app/model/Role.php](server/app/model/Role.php)
- [server/app/model/Permission.php](server/app/model/Permission.php)
- [server/app/model/Menu.php](server/app/model/Menu.php)
- [server/app/model/UserRole.php](server/app/model/UserRole.php)
- [server/app/model/RolePermission.php](server/app/model/RolePermission.php)
- [server/app/model/RoleMenu.php](server/app/model/RoleMenu.php)

**中间件**:
- [server/app/middleware/Permission.php](server/app/middleware/Permission.php)

**控制器**:
- [server/app/controller/UserController.php](server/app/controller/UserController.php)
- [server/app/controller/RoleController.php](server/app/controller/RoleController.php)
- [server/app/controller/MenuController.php](server/app/controller/MenuController.php)
- [server/app/controller/PermissionController.php](server/app/controller/PermissionController.php)

**文档**:
- [server/API_DOCUMENTATION.md](server/API_DOCUMENTATION.md)

### 修改的文件（共4个）

- [server/app/model/User.php](server/app/model/User.php) - 添加角色关联和新方法
- [server/app/controller/AuthController.php](server/app/controller/AuthController.php) - 添加获取用户菜单和权限的方法
- [server/route/app.php](server/route/app.php) - 添加权限管理路由
- [server/config/middleware.php](server/config/middleware.php) - 注册权限中间件

### 功能特性

1. **完整的 RBAC 权限模型**
   - 用户 - 角色（多对多）
   - 角色 - 权限（多对多）
   - 角色 - 菜单（多对多）

2. **菜单支持无限级树形结构**
   - 区分目录和可跳转路由
   - 支持前端动态路由渲染

3. **超级管理员机制**
   - 超级管理员拥有所有权限
   - 自动跳过权限验证

4. **统一的响应格式**
   ```json
   {
     "success": true,
     "message": "操作成功",
     "data": {}
   }
   ```

### 测试账号

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 超级管理员 | 拥有所有权限 |

---

## 日期

2026-02-04
