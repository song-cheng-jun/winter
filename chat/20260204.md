# 权限功能模块开发

## 用户的提问

**需求：** 补充系统上的权限功能模块，先做后台接口，并且输出接口文档。

需要包含：
1. **用户模块**：能增删改查用户
2. **角色模块**：角色可以添加到用户上，角色上关联着权限（有哪些前端页面）
3. **前端路由菜单**：树形无限级添加，用来动态渲染前端路由表，区分是目录还是可跳转的路由

---

## 解决过程

### 1. 数据库表设计

创建了完整的 RBAC 权限系统数据库表，包括：

| 表名 | 说明 |
|------|------|
| `roles` | 角色表 |
| `user_roles` | 用户-角色关联表（多对多） |
| `menus` | 菜单表（支持无限级树形结构） |
| `permissions` | 权限表 |
| `role_permissions` | 角色-权限关联表 |
| `role_menus` | 角色-菜单关联表 |

**SQL 脚本位置**: [server/create_rbac_tables.sql](server/create_rbac_tables.sql)

**初始化数据**：
- 3个默认角色（超级管理员、管理员、普通用户）
- 6个系统菜单
- 28个系统权限
- 超级管理员自动分配所有权限和菜单

### 2. 创建模型文件

创建了 6 个新模型：

| 文件 | 说明 |
|------|------|
| [app/model/Role.php](server/app/model/Role.php) | 角色模型，关联用户、权限、菜单 |
| [app/model/Permission.php](server/app/model/Permission.php) | 权限模型，关联菜单 |
| [app/model/Menu.php](server/app/model/Menu.php) | 菜单模型，支持树形结构 |
| [app/model/UserRole.php](server/app/model/UserRole.php) | 用户角色关联模型 |
| [app/model/RolePermission.php](server/app/model/RolePermission.php) | 角色权限关联模型 |
| [app/model/RoleMenu.php](server/app/model/RoleMenu.php) | 角色菜单关联模型 |

**修改 User 模型**，添加与角色的多对多关系：
- 添加 `roles()` 关联方法
- 添加 `getRoleIds()` 获取用户角色
- 添加 `hasRole()` 检查用户是否有指定角色
- 添加 `getPermissionCodes()` 获取用户权限代码
- 添加 `getMenuIds()` 获取用户菜单ID

### 3. 创建权限验证中间件

**文件**: [app/middleware/Permission.php](server/app/middleware/Permission.php)

功能：
- 路由与权限代码映射
- 超级管理员跳过验证
- 通过用户角色检查权限
- 返回 403 错误当无权限访问

### 4. 创建控制器

创建了 4 个新的管理控制器：

| 文件 | 接口数量 | 说明 |
|------|----------|------|
| [app/controller/UserController.php](server/app/controller/UserController.php) | 9个 | 用户CRUD、角色分配、状态管理、密码重置 |
| [app/controller/RoleController.php](server/app/controller/RoleController.php) | 10个 | 角色CRUD、权限分配、菜单分配 |
| [app/controller/MenuController.php](server/app/controller/MenuController.php) | 6个 | 菜单CRUD、树形结构查询 |
| [app/controller/PermissionController.php](server/app/controller/PermissionController.php) | 6个 | 权限CRUD、分组查询 |

**修改 AuthController**，添加新方法：
- `getUserMenus()` - 获取当前用户菜单树
- `getUserPermissions()` - 获取当前用户权限列表
- `getUserCompleteInfo()` - 获取当前用户完整信息（包含角色、菜单、权限）

### 5. 配置路由

**文件**: [server/route/app.php](server/route/app.php)

新增路由组：
- `/api/users/*` - 用户管理路由（9个接口）
- `/api/roles/*` - 角色管理路由（10个接口）
- `/api/menus/*` - 菜单管理路由（6个接口）
- `/api/permissions/*` - 权限管理路由（6个接口）
- `/api/auth/menus` - 获取当前用户菜单
- `/api/auth/permissions` - 获取当前用户权限
- `/api/auth/info` - 获取当前用户完整信息

### 6. 注册中间件

**文件**: [server/config/middleware.php](server/config/middleware.php)

注册权限中间件别名：
```php
'permission' => app\middleware\Permission::class,
```

### 7. 输出接口文档

**文件**: [server/API_DOCUMENTATION.md](server/API_DOCUMENTATION.md)

包含所有接口的详细文档：
- 请求方式和路径
- 请求参数说明
- 响应示例
- 权限要求
- 错误码说明

---

## 最终解决方案总结

### 创建的文件（共13个）

**数据库脚本**:
- [server/create_rbac_tables.sql](server/create_rbac_tables.sql)
- [server/execute_sql.php](server/execute_sql.php)

**模型文件**:
- [server/app/model/Role.php](server/app/model/Role.php)
- [server/app/model/Permission.php](server/app/model/Permission.php)
- [server/app/model/Menu.php](server/app/model/Menu.php)
- [server/app/model/UserRole.php](server/app/model/UserRole.php)
- [server/app/model/RolePermission.php](server/app/model/RolePermission.php)
- [server/app/model/RoleMenu.php](server/app/model/RoleMenu.php)

**中间件**:
- [server/app/middleware/Permission.php](server/app/middleware/Permission.php)

**控制器**:
- [server/app/controller/UserController.php](server/app/controller/UserController.php)
- [server/app/controller/RoleController.php](server/app/controller/RoleController.php)
- [server/app/controller/MenuController.php](server/app/controller/MenuController.php)
- [server/app/controller/PermissionController.php](server/app/controller/PermissionController.php)

**文档**:
- [server/API_DOCUMENTATION.md](server/API_DOCUMENTATION.md)

### 修改的文件（共4个）

- [server/app/model/User.php](server/app/model/User.php) - 添加角色关联和新方法
- [server/app/controller/AuthController.php](server/app/controller/AuthController.php) - 添加获取用户菜单和权限的方法
- [server/route/app.php](server/route/app.php) - 添加权限管理路由
- [server/config/middleware.php](server/config/middleware.php) - 注册权限中间件

### 功能特性

1. **完整的 RBAC 权限模型**
   - 用户 - 角色（多对多）
   - 角色 - 权限（多对多）
   - 角色 - 菜单（多对多）

2. **菜单支持无限级树形结构**
   - 区分目录和可跳转路由
   - 支持前端动态路由渲染

3. **超级管理员机制**
   - 超级管理员拥有所有权限
   - 自动跳过权限验证

4. **统一的响应格式**
   ```json
   {
     "success": true,
     "message": "操作成功",
     "data": {}
   }
   ```

### 测试账号

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123 | 超级管理员 | 拥有所有权限 |

---

## 日期

2026-02-04

---

# 前端权限管理页面开发

## 用户的提问

**需求：** 根据接口文档做出前端页面，并对接接口。

---

## 解决过程

### 1. 创建类型定义

创建 [web/src/types/permission.ts](web/src/types/permission.ts)，包含：
- Role、Menu、Permission 类型定义
- UserCompleteInfo、UserInfo、UserRole 类型
- 各种表单和查询参数类型
- API 响应类型

### 2. 创建 API 模块

创建了 4 个 API 模块文件：

| 文件 | 说明 |
|------|------|
| [web/src/api/users.ts](web/src/api/users.ts) | 用户管理 API（9个接口） |
| [web/src/api/roles.ts](web/src/api/roles.ts) | 角色管理 API（10个接口） |
| [web/src/api/menus.ts](web/src/api/menus.ts) | 菜单管理 API（6个接口） |
| [web/src/api/permissions.ts](web/src/api/permissions.ts) | 权限管理 API（6个接口） |

更新 [web/src/api/auth.ts](web/src/api/auth.ts)，新增方法：
- `getUserMenus()` - 获取用户菜单树
- `getUserPermissions()` - 获取用户权限列表
- `getUserCompleteInfo()` - 获取用户完整信息

### 3. 更新用户状态管理

修改 [web/src/stores/user.ts](web/src/stores/user.ts)，新增：
- `roles` - 用户角色列表
- `menus` - 用户菜单树
- `permissions` - 用户权限代码列表
- `getUserCompleteInfoAction()` - 获取完整信息
- `getUserMenusAction()` - 获取菜单
- `getUserPermissionsAction()` - 获取权限
- `hasPermission()` - 权限检查方法

更新 [web/src/utils/storage.ts](web/src/utils/storage.ts)，新增存储键：
- `USER_ROLES`
- `USER_MENUS`
- `USER_PERMISSIONS`

### 4. 创建管理页面

创建了 4 个系统管理页面：

| 文件 | 功能 |
|------|------|
| [web/src/views/system/user/index.vue](web/src/views/system/user/index.vue) | 用户管理：列表、新增、编辑、删除、角色分配、状态管理、密码重置 |
| [web/src/views/system/role/index.vue](web/src/views/system/role/index.vue) | 角色管理：列表、新增、编辑、删除、权限分配、菜单分配、查看用户 |
| [web/src/views/system/menu/index.vue](web/src/views/system/menu/index.vue) | 菜单管理：树形表格、新增、编辑、删除、无限级层级 |
| [web/src/views/system/permission/index.vue](web/src/views/system/permission/index.vue) | 权限管理：列表、新增、编辑、删除、按菜单分组 |

### 5. 创建后台管理布局

创建 [web/src/layouts/AdminLayout.vue](web/src/layouts/AdminLayout.vue)，包含：
- 侧边栏导航菜单（可折叠）
- 顶部导航栏（面包屑、用户信息、退出登录）
- 路由切换动画
- 动态菜单加载

### 6. 创建仪表盘首页

更新 [web/src/views/Home.vue](web/src/views/Home.vue)，包含：
- 统计卡片展示
- 快捷操作按钮
- 系统信息展示

### 7. 更新路由配置

修改 [web/src/router/index.ts](web/src/router/index.ts)：
- 使用嵌套路由结构
- AdminLayout 作为父布局
- 所有管理页面作为子路由

### 8. 解决跨域问题

更新 [web/vite.config.ts](web/vite.config.ts)，添加代理配置：
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://lib.com',
      changeOrigin: true,
      rewrite: (path) => path
    }
  }
}
```

更新 [web/src/utils/request.ts](web/src/utils/request.ts)，baseURL 改为空字符串使用代理。

### 9. 更新登录流程

修改 [web/src/views/Login.vue](web/src/views/Login.vue)，登录成功后加载：
- 用户菜单
- 用户权限

---

## 最终解决方案总结

### 创建的文件（共10个）

**类型定义**:
- [web/src/types/permission.ts](web/src/types/permission.ts)

**API 模块**:
- [web/src/api/users.ts](web/src/api/users.ts)
- [web/src/api/roles.ts](web/src/api/roles.ts)
- [web/src/api/menus.ts](web/src/api/menus.ts)
- [web/src/api/permissions.ts](web/src/api/permissions.ts)

**页面组件**:
- [web/src/layouts/AdminLayout.vue](web/src/layouts/AdminLayout.vue)
- [web/src/views/system/user/index.vue](web/src/views/system/user/index.vue)
- [web/src/views/system/role/index.vue](web/src/views/system/role/index.vue)
- [web/src/views/system/menu/index.vue](web/src/views/system/menu/index.vue)
- [web/src/views/system/permission/index.vue](web/src/views/system/permission/index.vue)

### 修改的文件（共7个）

- [web/src/types/index.ts](web/src/types/index.ts) - 导出权限类型
- [web/src/api/auth.ts](web/src/api/auth.ts) - 新增菜单、权限、完整信息接口
- [web/src/api/index.ts](web/src/api/index.ts) - 导出所有 API 模块
- [web/src/utils/storage.ts](web/src/utils/storage.ts) - 新增角色、菜单、权限存储键
- [web/src/stores/user.ts](web/src/stores/user.ts) - 新增角色、菜单、权限状态
- [web/src/router/index.ts](web/src/router/index.ts) - 嵌套路由结构
- [web/src/views/Home.vue](web/src/views/Home.vue) - 仪表盘页面
- [web/src/views/Login.vue](web/src/views/Login.vue) - 登录后加载菜单权限
- [web/vite.config.ts](web/vite.config.ts) - 代理配置
- [web/src/utils/request.ts](web/src/utils/request.ts) - baseURL 配置

### 功能特性

1. **完整的 RBAC 前端实现**
   - 用户管理：CRUD、角色分配、状态管理、密码重置
   - 角色管理：CRUD、权限分配、菜单分配
   - 菜单管理：树形结构、无限级层级
   - 权限管理：列表、分组展示

2. **后台管理系统布局**
   - 侧边栏导航（可折叠）
   - 顶部导航栏（面包屑、用户信息）
   - 路由切换动画
   - 动态菜单加载

3. **Element Plus 组件**
   - 表格、分页、对话框
   - 表单验证
   - 树形选择器
   - 消息提示

### 访问路径

| 路径 | 页面 |
|------|------|
| /home | 首页仪表盘 |
| /system/user | 用户管理 |
| /system/role | 角色管理 |
| /system/menu | 菜单管理 |
| /system/permission | 权限管理 |

---

## 日期

2026-02-04
