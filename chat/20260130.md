# 图书管理系统登录功能开发记录

我的提问：我需要做一个图书管理系统，现在做第一步，登录功能；现在我的根目录有两个文件夹，web是我的vue项目；server是服务端项目使用thinkphp框架，都是空的，需要你来生成功能代码；因为我是前端开发，服务单项目要写详细注释；登录功能需要你创建用户数据库表，以及相关登录，取用户信息接口；前端是pc端网页需要做好：登录页面以及接口对接，登录完成取用户信息，本地缓存用户信息登录状态保持；

**日期**: 2026-01-30

---

## 项目概述

为图书管理系统实现完整的用户登录功能，包含前后端完整实现。

### 技术栈
- **服务端**: ThinkPHP 8 + PHP 8.0+ + MySQL
- **前端**: Vue 3 + TypeScript + Pinia + Vue Router 4 + Axios
- **认证方式**: JWT Token
- **密码加密**: PHP password_hash

---

## 实现的功能

### 服务端功能
1. **用户数据表** - 包含用户名、密码（加密）、昵称、角色等字段
2. **JWT 认证** - Token 生成和验证中间件
3. **登录接口** - POST `/api/auth/login`
4. **获取用户信息接口** - GET `/api/auth/userinfo`
5. **登出接口** - POST `/api/auth/logout`

### 前端功能
1. **登录页面** - 渐变背景卡片样式，表单验证
2. **首页** - 显示用户信息，退出登录功能
3. **状态管理** - Pinia Store 管理登录状态
4. **本地存储** - Token 和用户信息持久化
5. **路由守卫** - 未登录自动跳转登录页

---

## 创建的文件清单

### 服务端文件

| 文件路径 | 说明 |
|----------|------|
| `server/config/jwt.php` | JWT配置文件（密钥、过期时间等） |
| `server/app/model/User.php` | 用户模型（用户查询、密码验证） |
| `server/app/middleware/JwtAuth.php` | JWT认证中间件 |
| `server/app/controller/AuthController.php` | 认证控制器 |
| `server/config/middleware.php` | 中间件配置 |
| `server/route/app.php` | 路由配置 |
| `server/composer.json` | 添加 firebase/php-jwt 依赖 |

### 前端文件

| 文件路径 | 说明 |
|----------|------|
| `web/src/types/index.ts` | TypeScript类型定义 |
| `web/src/utils/storage.ts` | 本地存储工具封装 |
| `web/src/utils/request.ts` | Axios请求封装 |
| `web/src/api/auth.ts` | 认证API封装 |
| `web/src/api/index.ts` | API统一导出 |
| `web/src/stores/user.ts` | 用户状态管理（Pinia） |
| `web/src/views/Login.vue` | 登录页面组件 |
| `web/src/views/Home.vue` | 首页组件 |
| `web/src/router/index.ts` | 路由配置和导航守卫 |
| `web/src/assets/styles/variables.scss` | SCSS变量定义 |
| `web/src/App.vue` | 根组件（已更新） |

---

## 数据库表结构

```sql
CREATE TABLE `users` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名（登录账号）',
  `password` varchar(255) NOT NULL COMMENT '密码（password_hash加密）',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `status` tinyint(1) DEFAULT '1' COMMENT '状态：1正常 0禁用',
  `role` varchar(20) DEFAULT 'user' COMMENT '角色：admin管理员 user普通用户',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `created_at` datetime DEFAULT NULL COMMENT '创建时间',
  `updated_at` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

---

## API 接口文档

### 1. 用户登录
```
POST /api/auth/login

请求体:
{
  "username": "admin",
  "password": "password"
}

响应:
{
  "success": true,
  "message": "登录成功",
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "userInfo": { ... }
  }
}
```

### 2. 获取用户信息
```
GET /api/auth/userinfo
Headers: Authorization: Bearer {token}

响应:
{
  "success": true,
  "message": "获取用户信息成功",
  "data": { ... }
}
```

### 3. 用户登出
```
POST /api/auth/logout
Headers: Authorization: Bearer {token}

响应:
{
  "success": true,
  "message": "登出成功"
}
```

---

## 部署步骤

### 1. 创建数据库和表
```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS library DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE library;

-- 创建用户表（见上文表结构）

-- 插入测试账号（密码是 "password"）
INSERT INTO `users` (`username`, `password`, `nickname`, `role`, `status`, `created_at`, `updated_at`)
VALUES ('admin', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', '管理员', 'admin', 1, NOW(), NOW());
```

### 2. 配置数据库连接
编辑 `server/.env` 或 `server/config/database.php` 设置数据库连接信息。

### 3. 安装服务端依赖
```bash
cd server
composer update
```

### 4. 启动服务
```bash
# 服务端（在 server 目录）
php think run

# 前端（在 web 目录）
npm run dev
```

### 5. 访问系统
```
前端地址: http://localhost:5173
服务端地址: http://localhost:8000
```

### 6. 测试登录
- 用户名：`admin`
- 密码：`password`

---

## 测试账号

| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | password | 管理员 |

---

## 安全注意事项

1. **密码加密** - 使用 PHP `password_hash` 加密存储
2. **JWT Secret** - 生产环境请使用复杂的随机字符串
3. **HTTPS** - 生产环境建议启用 HTTPS
4. **SQL 注入** - 使用参数绑定防止 SQL 注入
5. **Token 过期** - 默认7天，可根据需要调整

---

## 后续扩展建议

1. **用户注册功能** - 添加用户注册接口和页面
2. **密码重置** - 实现忘记密码/重置密码功能
3. **权限管理** - 实现基于角色的权限控制
4. **刷新Token** - 实现Token刷新机制
5. **第三方登录** - 支持微信、QQ等第三方登录

---

## 代码规范

- **服务端**: 使用 `declare (strict_types = 1);` 启用严格类型检查
- **前端**: 使用 TypeScript 类型检查
- **注释**: 服务端代码包含详细中文注释
- **命名**: 遵循 PSR-4 自动加载规范

---

*开发完成日期: 2026-01-30*
